var gStampData=null;var gPdfData=null;var gRotateValue=1;var bMouseSeal=false;var bOpendStampMenu=false;var bDocSignValid=true;var gPinCode="";var service_url="http://localhost:53618/";var getSignCert_url=service_url+"GetCertInfo";var signb64Data_url=service_url+"GetSignValue";var loadSeal_url=service_url+"getStampList";var openFile_url=service_url+"openFile";var stamp_url=service_url+"StampFile";var removeStamp_url=service_url+"RemoveStamp";var autoRemoveStamp_url=service_url+"AutoRemoveStamp";var saveAs_url=service_url+"SaveFile";var getCertList_url=service_url+"getCertList";var exitCertList_url=service_url+"exitCertList";var gOnlineFile=null;var gLastSealId=null;var gCurDocType=0;var gCurUserSealIndex=0;var gCurUserSealRotate=0;var gCurCertContainer=null;var gUploadUrl=null;var gUploadFileName=null;var isHideBtn=false;function b64EncodeUnicode(b){return btoa(encodeURIComponent(b).replace(/%([0-9A-F]{2})/g,function a(c,d){return String.fromCharCode("0x"+d)}))}function b64DecodeUnicode(a){return decodeURIComponent(atob(a).split("").map(function(b){return"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function OpenFileErr(a){switch(a.status){case 500:alert("服务器系统内部错误");break;case 401:alert("访问被拒绝");break;case 403:alert("无权限执行此操作");break;case 408:alert("请求超时");break;default:alert("未知错误")}}function createSealContainer(e){var c=e.pdfWidth;var j=e.pdfHeight;var b=e.pageCount;gLastSealId=e.signatureList.length-1;if(!PDFViewerApplication.pdfViewer._location){return}var a=0;var g=function(k,m,i){var p=(i!==undefined?i:k.atPage);var q=a;a++;var n=document.getElementById("pageContainer"+p);if(n){var o=document.getElementById("sealContainer"+q);if(!o){o=document.createElement("div");n.appendChild(o)}else{n.appendChild(o)}o.id="sealContainer"+q;o.setAttribute("seal-index",m.toString());o.setAttribute("current-page",p.toString());o.setAttribute("seal-id",q.toString());o.style.position="absolute";var l=parseInt(n.style.width)/c;var r=parseInt(n.style.height)/j;if(gRotateValue===1){o.style.left=k.pos.lx*l+"px";o.style.top=(j-k.pos.ly)*r+"px";o.style.width=k.width*l+"px";o.style.height=k.height*r+"px"}else{if(gRotateValue===2){l=parseInt(page.style.height)/c;r=parseInt(page.style.width)/j;o.style.left=(k.pos.ly-k.height)*r+"px";o.style.top=k.pos.lx*l+"px";o.style.width=k.height*r+"px";o.style.height=k.width*l+"px"}else{if(gRotateValue===3){o.style.left=(c-k.pos.lx-k.width)*l+"px";o.style.top=(k.pos.ly-k.height)*r+"px";o.style.width=k.width*l+"px";o.style.height=k.height*r+"px"}else{if(gRotateValue===4){l=parseInt(page.style.height)/c;r=parseInt(page.style.width)/j;o.style.left=(j-k.pos.ly)*r+"px";o.style.top=(c-k.pos.lx-k.width)*l+"px";o.style.width=k.height*r+"px";o.style.height=k.width*l+"px"}}}}o.style.zIndex="9999";o.onmouseover=function(v){isHideBtn=false;showVerifyBtn(this);var s=parseInt(this.getAttribute("seal-index"));var t=parseInt(this.getAttribute("seal-id"));var w=false;if(e.signatureList[s].signatureName.indexOf("PagingSeal_")!==-1||e.signatureList[s].signatureName.indexOf("SignStamps_")!==-1){if(e.signatureList[gLastSealId].signatureName.indexOf("PagingSeal_")!==-1||e.signatureList[gLastSealId].signatureName.indexOf("SignStamps_")!==-1){if(t>a-b-1){w=true}}}else{if(t===a-1){w=true}}if(w){showRemoveBtn(this)}else{var u=document.getElementById("removeButton");if(u){u.style.visibility="hidden"}}};o.onmouseout=function(s){isHideBtn=true;setTimeout(function(){if(isHideBtn){var v=document.getElementById("verifyButton");if(v){v.style.visibility="hidden"}var t=document.getElementById("removeButton");if(t){t.style.visibility="hidden"}var u=document.getElementById("signatureInf");if(u){u.style.visibility="hidden"}}},2000)}}};var f=function(k,l){for(var m=1;m!==b+1;++m){g(k,l,m)}};var h=function(l,m){var k=l.atPage;var n=0;do{g(l,m,k);++n;k+=10}while(k<=b)};for(var d=0;d<e.signatureList.length;++d){if(e.signatureList[d].signatureName.indexOf("SignStamps_")!==-1){f(e.signatureList[d],d)}else{if(e.signatureList[d].signatureName.indexOf("PagingSeal_")!==-1){h(e.signatureList[d],d)}else{g(e.signatureList[d],d)}}}}function showVerifyBtn(a){var b=document.getElementById("verifyButton");if(b===null){b=document.createElement("button");b.id="verifyButton";b.innerText="验章";b.style.width="60px";b.style.zIndex="10000";b.style.position="absolute";b.style.padding="2px 5px";b.style.backgroundColor="#008b45";b.style.color="white";b.style.border="none";b.style.cursor="pointer";b.onmouseover=function(){isHideBtn=false;this.style.backgroundColor="green";this.style.visibility="visible";var d=document.getElementById("removeButton");var c=parseInt(this.getAttribute("seal-index"));if(d&&c===gLastSealId){d.style.visibility="visible"}};b.onmouseout=function(){isHideBtn=true;this.style.backgroundColor="#008b45"}}$("#pageContainer"+a.getAttribute("current-page")).append(b);b.setAttribute("seal-index",a.getAttribute("seal-index"));b.setAttribute("current-page",a.getAttribute("current-page"));b.setAttribute("seal-id",a.getAttribute("seal-id"));b.style.visibility="visible";b.style.left=a.style.left;b.style.top=a.style.top;b.onclick=verifySeal}function showRemoveBtn(b){var a=document.getElementById("removeButton");if(a===null){a=document.createElement("button");a.id="removeButton";a.innerText="撤销";a.style.width="60px";a.style.zIndex="10000";a.style.position="absolute";a.style.padding="2px 5px";a.style.backgroundColor="#008b45";a.style.color="white";a.style.border="none";a.style.cursor="pointer";a.onmouseover=function(){isHideBtn=false;this.style.backgroundColor="green";this.style.visibility="visible";var c=document.getElementById("verifyButton");if(c){c.style.visibility="visible"}};a.onmouseout=function(){isHideBtn=true;this.style.backgroundColor="#008b45"}}$("#pageContainer"+b.getAttribute("current-page")).append(a);a.setAttribute("seal-index",b.getAttribute("seal-index"));a.setAttribute("current-page",b.getAttribute("current-page"));a.style.visibility="visible";a.style.left=parseFloat(b.style.left)+61+"px";a.style.top=b.style.top;a.onclick=showRemoveSeal}function verifySeal(){var f=parseInt(this.getAttribute("seal-index"));var b=document.getElementById("signatureInf");if(b){b.parentNode.removeChild(b)}b=document.createElement("div");b.id="signatureInf";var e=3;for(var d=0;d<e;++d){var k=document.createElement("div");var h=document.createElement("span");var a=document.createElement("p");k.appendChild(h);k.appendChild(a);b.appendChild(k);k.style.display="table-row";h.style.wordWrap="break-word";h.style.display="table-cell";h.style.width="70px";a.style.wordWrap="break-word";a.style.display="table-cell";var c=null;if(d===0){c=document.createTextNode("签名者：");h.appendChild(c);c=document.createTextNode(gPdfData.listVerify[f].SignCertificateName);a.appendChild(c)}else{if(d===1){c=document.createTextNode("签名时间：");h.appendChild(c);c=document.createTextNode(gPdfData.listVerify[f].SignDate.replace("T"," ").replace("+08:00",""));a.appendChild(c)}else{c=document.createTextNode("签名状态：");h.appendChild(c);if(gPdfData.listVerify[f].IsValid){c=document.createTextNode("签名有效")}else{c=document.createTextNode("签名无效")}a.appendChild(c)}}}$("#pageContainer"+this.getAttribute("current-page")).append(b);var j=this.getAttribute("seal-id");var g=document.getElementById("sealContainer"+j);if(g){b.style.visibility="visible";b.style.position="absolute";b.style.left=parseFloat(g.style.left)+g.offsetWidth+"px";b.style.top=g.style.top}}function showRemoveSeal(){document.getElementById("removeSealOverlayContainer").style.visibility="visible"}function removeSeal(){SetWaitingInfo("正在撤销签名");ShowWaitingInfo("visible");var a=gPdfData.filePath;var d=gPdfData.signatureList[gLastSealId].signatureName;var c={FilePath:a,SignatureName:d,Container:gCurCertContainer};var b=b64EncodeUnicode(JSON.stringify(c));$.ajax({url:removeStamp_url,type:"get",dataType:"text",data:{jsonData:b},success:function(f,h,e){var g=jQuery.parseJSON(f);if(g.ResCode===0){gPdfData=g;renderPdf(g);if(gCurDocType===1){setTitle(gOnlineFile,1)}else{setTitle(gPdfData,0)}}else{alert(g.ResString)}ShowWaitingInfo("hidden")},error:function(e,g,f){alert("请先打开信鉴易签章服务：开始程序->信鉴易电子印章阅读器->信鉴易签章服务。");ShowWaitingInfo("hidden")}})}function createViewVeriSignature(k){try{var p=document.getElementById("veriSignatureView");for(var l=0;l<k.listVerify.length;++l){var s="签名者："+k.listVerify[l].SignCertificateName;var e=k.listVerify[l].IsValid?"签名有效":"签名无效";var r=k.listVerify[l].SignDate.replace("T"," ");r=r.replace("-","/");r=r.replace("-","/");r=r.replace("+08:00","");var n="签名区域位于第"+k.signatureList[l].atPage.toString()+"页";var o="详细信息 ...";var m,g,f,d,c,b,j,q;m=document.createElement("dl");g=document.createElement("dt");f=document.createElement("dt");d=document.createElement("dt");c=document.createElement("dt");b=document.createElement("dt");j=document.createElement("img");q=document.createElement("a");m.style.marginBottom="15px";m.style.marginTop="10px";if(k.listVerify[l].IsValid){j.src="images/veriSignature-valid.png";f.style.color="green"}else{j.scr="images/veriSignature-Invalid.png";f.style.color="red"}j.style.verticalAlign="middle";j.style.marginRight="8px";j.style.marginLeft="8px";f.style.paddingLeft="34px";d.style.paddingLeft="34px";d.onmouseover=function(a){this.style.backgroundColor="#dcdcdc"};d.onmouseout=function(a){this.style.backgroundColor="transparent"};c.style.paddingLeft="34px";c.style.cursor="pointer";c.setAttribute("data-atPage",k.signatureList[l].atPage.toString());c.onmouseover=function(a){this.style.backgroundColor="#dcdcdc"};c.onmouseout=function(a){this.style.backgroundColor="transparent"};c.onclick=function(a){PDFViewerApplication.pdfViewer.currentPageNumber=parseInt(this.getAttribute("data-atPage"))};b.style.paddingLeft="34px";b.setAttribute("data-index",l.toString());b.style.cursor="pointer";b.onmouseover=function(a){this.style.backgroundColor="#dcdcdc"};b.onmouseout=function(a){this.style.backgroundColor="transparent"};b.onclick=function(i){var a=this.getAttribute("data-index");setSignatureProperties(a);showSignatureProperties("visible")};q.innerText=s;g.appendChild(j);g.appendChild(q);f.innerText=e;d.innerText=r;c.innerText=n;b.innerText=o;m.appendChild(g);m.appendChild(f);m.appendChild(d);m.appendChild(c);m.appendChild(b);p.appendChild(m)}}catch(h){alert(h.message)}}function parseCert(d,c){var f=new Array(c.length);var e,a;for(var b=0;b<c.length;++b){e=d.indexOf(c[b]);if(e!==-1){a=d.indexOf(",",e);if(a!==-1){f[b]=d.substring(e,a)}else{f[b]=d.substring(e)}}else{f[b]=null}}return f}function parseUserCert(b){var a=new Array("CN=","O=","L=","S=","C=");return parseCert(b,a)}function parseIssuerCert(b){var a=new Array("CN=","OU=","O=","L=","S=","C=");return parseCert(b,a)}function setInnerText(b,a){document.getElementById(b).innerText=a}function setSignatureProperties(a){var b=parseInt(a);setInnerText("signatureUser",gPdfData.listVerify[b].SignCertificateName);if(gPdfData.listVerify[b].IsValid){document.getElementById("signatureStatue").style.color="green";setInnerText("signatureStatue","签名有效，证书链完整")}else{document.getElementById("signatureStatue").style.color="red";setInnerText("signatureStatue","签名无效")}setInnerText("signatureTime",gPdfData.listVerify[b].SignDate.replace("T"," "));var c=parseUserCert(gPdfData.listVerify[b].CertInfo.SubjectName);setInnerText("userCertCN",c[0]);setInnerText("userCertO",c[1]);setInnerText("userCertL",c[2]);setInnerText("userCertS",c[3]);setInnerText("userCertC",c[4]);c=parseIssuerCert(gPdfData.listVerify[b].CertInfo.IssuerName);setInnerText("parentCertCN",c[0]);setInnerText("parentCertOU",c[1]);setInnerText("parentCertO",c[2]);setInnerText("parentCertL",c[3]);setInnerText("parentCertS",c[4]);setInnerText("parentCertC",c[5]);setInnerText("serialNumber",gPdfData.listVerify[b].CertInfo.SerialNumber);setInnerText("beginTime",gPdfData.listVerify[b].CertInfo.NotBefore.replace("T"," "));setInnerText("endTime",gPdfData.listVerify[b].CertInfo.NotAfter.replace("T"," "));setInnerText("certPublicKey",gPdfData.listVerify[b].CertInfo.keySize)}function showSignatureProperties(a){document.getElementById("signaturePropertiesOverlayContainer").style.visibility=a}$(document).ready(function(){var a=document.getElementById("thumbnailView");var f=document.getElementById("outlineView");var e=document.getElementById("attachmentsView");var c=document.getElementById("veriSignatureView");var b=document.getElementById("viewThumbnail");var g=document.getElementById("viewOutline");var h=document.getElementById("viewAttachments");var d=document.getElementById("viewVeriSignature");$("#viewVeriSignature").click(function(){b.classList.remove("toggled");g.classList.remove("toggled");h.classList.remove("toggled");d.classList.add("toggled");a.classList.add("hidden");f.classList.add("hidden");e.classList.add("hidden");c.classList.remove("hidden")});$("#viewThumbnail").click(function(){d.classList.remove("toggled");c.classList.add("hidden")});$("#viewOutline").click(function(){d.classList.remove("toggled");c.classList.add("hidden")})});function b64toBlob(k,j,b){j=j||"";b=b||512;var e=atob(k);var g=[];for(var c=0;c<e.length;c+=b){var h=e.slice(c,c+b);var f=new Array(h.length);for(var d=0;d<h.length;d++){f[d]=h.charCodeAt(d)}var a=new Uint8Array(f);g.push(a)}return new Blob(g,{type:j})}function HideVerifyView(){document.getElementById("veriSignatureView").classList.add("hidden");document.getElementById("viewVeriSignature").classList.remove("toggled");if(!bDocSignValid){bDocSignValid=true;var a=document.getElementById("verifyBar");a.style.visibility="hidden"}}function renderPdf(d){try{HideVerifyView();document.getElementById("veriSignatureView").innerText="";gRotateValue=1;var b=b64toBlob(d.fileData);var a=URL.createObjectURL(b);PDFViewerApplication.open(a);openFileCallBack=function(){createViewVeriSignature(d)}}catch(c){alert(c.message)}}function setTitle(c,b){var a;if(b===0){a=c.filePath;a=b64DecodeUnicode(a);if(a===null){return}a=a.split("\\")}else{a=c;a=a.split("/")}document.title=a[a.length-1]}function openLocalFile(){gCurDocType=0;var a={Random:Math.random(),Type:"Local"};var b=b64EncodeUnicode(JSON.stringify(a));SetWaitingInfo("文件开启中");ShowWaitingInfo("visible");$.ajax({url:openFile_url,async:true,type:"get",dataType:"text",data:{jsonData:b},complete:function(d,c){if(c===""){alert("连接超时！");ShowWaitingInfo("hidden")}},success:function(d,f,c){var e=jQuery.parseJSON(d);if(e.ResCode===0){renderPdf(e);setTitle(e,gCurDocType);gPdfData=e;setTimeout("verifyDocValidity()",2000)}else{if(e.ResCode===-101){}else{if(e.ResCode===-102){alert("文档已加密！")}else{alert("文档打开失败！")}}}ShowWaitingInfo("hidden")},error:function(c,e,d){alert("请先打开信鉴易签章服务：开始程序->信鉴易电子印章阅读器->信鉴易签章服务。");ShowWaitingInfo("hidden")}})}function openOnlineFile(b){if(b===null){return}gOnlineFile=b;gCurDocType=1;var a={Random:Math.random(),Type:"Online",Url:b};var c=JSON.stringify(a);c=b64EncodeUnicode(c);if(c===null){return}SetWaitingInfo("文档打开中");ShowWaitingInfo("visible");$.ajax({url:openFile_url,async:true,type:"get",dataType:"text",data:{jsonData:c},complete:function(e,d){if(d==="timeout"){alert("连接超时！");ShowWaitingInfo("hidden")}},success:function(e,g,d){var f=jQuery.parseJSON(e);if(f.ResCode===0){renderPdf(f);setTitle(b,gCurDocType);gPdfData=f;setTimeout("verifyDocValidity()",2000)}else{alert("文件打开失败: "+b)}ShowWaitingInfo("hidden")},error:function(d,f,e){ShowWaitingInfo("hidden");OpenFileErr(d);alert("请先打开信鉴易签章服务：开始程序->信鉴易电子印章阅读器->信鉴易签章服务。")}})}function verifyDocValidity(){if(gPdfData===null){return}if(gPdfData.signatureList.length===0){return}var c=true;for(var e=0;e<gPdfData.signatureList.length;++e){if(!gPdfData.listVerify[e].IsValid){c=false}}bDocSignValid=c;var b=document.getElementById("verifyBar");b.style.visibility="visible";var a=document.getElementById("verifyBarImg");var d=document.getElementById("verifyStatus");if(c){a.src="images/verifyBar-valid.png";b.style.backgroundColor="#96d196";d.style.color="#183818";d.innerText="已经签名且所有签名有效";setTimeout(function(){b.style.visibility="hidden"},5000)}else{a.src="images/verifyBar-invalid.png";b.style.backgroundColor="#ffde79";d.style.color="#7b4e00";d.innerText="至少一个签名有问题"}}function LoadSeal(b,c,e){if(gPdfData===null){alert("请先打开一个文档！");return}if(!bDocSignValid){alert("文档存在无效签名，不支持盖章操作！");return}switchSelectCurosrTool();var f={StampType:c,PIN:b,Random:Math.random()};var d=b64EncodeUnicode(JSON.stringify(f));var a={Random:Math.random()};$.ajax({url:loadSeal_url,type:"get",dataType:"text",data:{JsonData:d},success:function(h,j,g){var i=jQuery.parseJSON(h);if(i.ResCode===0){gStampData=i;if(e===3){openUserSealDialog(i)}else{startStamp(e,0,null,null)}}else{if(i.ResCode===-1){$.ajax({url:getCertList_url,type:"get",success:function(p,q,o){var k=jQuery.parseJSON(p);if(k.ResCode===-1){alert("获取证书列表失败！");return}if(gCurCertContainer===null){gCurCertContainer=k[0].certContaimer}var m=document.getElementById("certificateList");if(m){m.innerText="";for(var l=0;l!==k.length;++l){var n=document.createElement("option");n.innerText=k[l].certName+"--"+k[l].certContaimer;n.value=k[l].certContaimer;m.appendChild(n)}}}});gCurCertContainer=null;document.getElementById("certificateList").innerText="";document.getElementById("stampLoginOverlayContainer").style.visibility="visible";document.getElementById("stampLoingPinCode").value=""}else{alert(i.ResString)}}ShowWaitingInfo("hidden")},error:function(g,i,h){alert("请先打开信鉴易签章服务：开始程序->信鉴易电子印章阅读器->信鉴易签章服务。")}})}function calCurSealSize(e,b,d,a){var i=e;var f=b;var h=d/72*25.4;var g=a/72*25.4;var c;if(d>=a){c=d/a;d=i;a=i/c}else{c=a/d;a=f;d=f/c}return{width:d,height:a,width_mm:h.toFixed(1),height_mm:g.toFixed(1)}}function openUserSealDialog(e){var h=e.StampList.length;var g=gCurUserSealIndex;var k=e.StampList[g].StampName;var d=e.StampList[g].Width;var b=e.StampList[g].Height;var j=(++g).toString()+" / "+h.toString();var i=document.getElementById("curSealContainer");var a=calCurSealSize(i.offsetWidth,i.offsetHeight,d,b);var c=document.getElementById("userSealImg");if(c===null){c=document.createElement("img");c.id="userSealImg"}c.style.width=a.width+"px";c.style.height=a.height+"px";c.src="data:image/bmp;base64,"+e.StampList[--g].ImageBinary;c.setAttribute("seal-index",g.toString());c.setAttribute("seal-width",a.width.toString());c.setAttribute("seal-height",a.height.toString());c.setAttribute("seal-width-mm",a.width_mm.toString());c.setAttribute("seal-height-mm",a.height_mm.toString());i.appendChild(c);gCurUserSealIndex=0;rotateDOMElement(c,gCurUserSealRotate);document.getElementById("curSealIndex").innerText=j;document.getElementById("curSealName").innerText=k;document.getElementById("normalMode").classList.add("modeSelected");document.getElementById("allPageMode").classList.remove("modeSelected");document.getElementById("pageGapMode").classList.remove("modeSelected");document.getElementById("userSealWidth").value=a.width_mm;document.getElementById("userSealHeight").value=a.height_mm;gCurStampMode=0;var f=document.getElementById("userSealContainer");f.style.visibility="visible"}$(document).ready(function(){$("#goRightSeal").click(function(){visitSeal("right")});$("#goLeftSeal").click(function(){visitSeal("left")});$("#normalMode").click(function(){gCurStampMode=0;document.getElementById("normalMode").classList.add("modeSelected");document.getElementById("allPageMode").classList.remove("modeSelected");document.getElementById("pageGapMode").classList.remove("modeSelected")});$("#allPageMode").click(function(){gCurStampMode=1;document.getElementById("normalMode").classList.remove("modeSelected");document.getElementById("allPageMode").classList.add("modeSelected");document.getElementById("pageGapMode").classList.remove("modeSelected")});$("#pageGapMode").click(function(){gCurStampMode=2;document.getElementById("normalMode").classList.remove("modeSelected");document.getElementById("allPageMode").classList.remove("modeSelected");document.getElementById("pageGapMode").classList.add("modeSelected")});$("#userSealWidth").click(function(){var d=document.getElementById("userSealWidth");var a=document.getElementById("userSealHeight");var b=document.getElementById("userSealImg");var c=parseFloat(b.getAttribute("seal-width"))/parseFloat(b.getAttribute("seal-height"));if(d&&a&&b){d.oninput=function(e){document.getElementById("preSettingSize")[6].selected=true;this.value=this.value.replace(/[^\d]/g,"");a.value=parseInt(this.value/c);gCurUserSealRotate=0;rotateDOMElement(document.getElementById("userSealImg"),gCurUserSealRotate)}}});$("#userSealHeight").click(function(){var d=document.getElementById("userSealWidth");var a=document.getElementById("userSealHeight");var b=document.getElementById("userSealImg");var c=parseFloat(b.getAttribute("seal-width"))/parseFloat(b.getAttribute("seal-height"));if(d&&a&&b){a.oninput=function(e){document.getElementById("preSettingSize")[6].selected=true;this.value=this.value.replace(/[^\d]/g,"");d.value=parseInt(this.value*c);gCurUserSealRotate=0;rotateDOMElement(document.getElementById("userSealImg"),gCurUserSealRotate)}}});$("#sealBtnOk").click(function(){var a,c;if(gCurUserSealRotate===90||gCurUserSealRotate===270||gCurUserSealRotate===-90||gCurUserSealRotate===-270){a=document.getElementById("userSealHeight").value;c=document.getElementById("userSealWidth").value}else{a=document.getElementById("userSealWidth").value;c=document.getElementById("userSealHeight").value}a=a/25.4*72;c=c/25.4*72;var d=document.getElementById("userSealImg");var b=parseInt(d.getAttribute("seal-index"));document.getElementById("userSealContainer").style.visibility="hidden";startStamp(gCurStampMode,b,a,c)});$("#preSettingSize").change(function(){gCurUserSealRotate=0;rotateDOMElement(document.getElementById("userSealImg"),gCurUserSealRotate);var b=$("#preSettingSize").get(0).selectedIndex;var f=function(j,g){var m=document.getElementById("userSealImg");var l=parseInt(m.getAttribute("seal-width"));var i=parseInt(m.getAttribute("seal-height"));var k,h;if(j>=g){k=j;h=j*i/l}else{h=g;k=g*l/i}return{width:k.toFixed(1),height:h.toFixed(1)}};var a=document.getElementById("userSealWidth");var e=document.getElementById("userSealHeight");var c={};switch(b){case 0:var d=document.getElementById("userSealImg");c.width=parseFloat(d.getAttribute("seal-width-mm"));c.height=parseFloat(d.getAttribute("seal-height-mm"));break;case 1:c=f(58,58);break;case 2:c=f(42,42);break;case 3:c=f(40,40);break;case 4:c=f(40,30);break;case 5:c=f(20,20);break;case 6:c.width=a.value;c.height=e.value;break;default:return}a.value=c.width;e.value=c.height});$("#rotateLeft").click(function(){gCurUserSealRotate=(gCurUserSealRotate===-270)?0:gCurUserSealRotate-90;rotateDOMElement(document.getElementById("userSealImg"),gCurUserSealRotate);var a=document.getElementById("userSealWidth").value;var b=document.getElementById("userSealHeight").value;document.getElementById("userSealWidth").value=b;document.getElementById("userSealHeight").value=a});$("#rotateRight").click(function(){gCurUserSealRotate=(gCurUserSealRotate===270)?0:gCurUserSealRotate+90;rotateDOMElement(document.getElementById("userSealImg"),gCurUserSealRotate);var a=document.getElementById("userSealWidth").value;var b=document.getElementById("userSealHeight").value;document.getElementById("userSealWidth").value=b;document.getElementById("userSealHeight").value=a})});function rotateDOMElement(a,b){a.style.webkitTransform="rotate("+b+"deg)";a.style.msTransform="rotate("+b+"deg)";a.style.MozTransform="rotate("+b+"deg)";a.style.OTransform="rotate("+b+"deg)";a.style.transform="rotate("+b+"deg)"}function visitSeal(g){var f=document.getElementById("userSealImg");var e=document.getElementById("curSealContainer");if(f&&e){var a=gStampData.StampList.length;var b=parseInt(f.getAttribute("seal-index"));var c=(g==="right"?(++b)!==a:(--b)!==-1);if(c){gCurUserSealIndex=b;gCurUserSealRotate=0;rotateDOMElement(f,gCurUserSealRotate);var d=calCurSealSize(e.offsetWidth,e.offsetHeight,gStampData.StampList[b].Width,gStampData.StampList[b].Height);f.setAttribute("seal-index",b.toString());f.setAttribute("seal-width",d.width.toString());f.setAttribute("seal-Height",d.height.toString());f.setAttribute("seal-width-mm",d.width_mm.toString());f.setAttribute("seal-height-mm",d.height_mm.toString());f.style.width=d.width+"px";f.style.height=d.height+"px";f.src="data:image/bmp;base64,"+gStampData.StampList[b].ImageBinary;document.getElementById("curSealName").innerText=gStampData.StampList[b].StampName;document.getElementById("curSealIndex").innerText=(++b).toString()+" / "+a.toString();document.getElementById("userSealWidth").value=d.width_mm;document.getElementById("userSealHeight").value=d.height_mm;document.getElementById("preSettingSize")[0].selected=true}}}var gCurStampMode=0;var gCurSealIndex=0;function startStamp(l,i,e,a){if(gRotateValue!==1){alert("文档旋转后不支持盖章，请恢复旋转再盖章！");return}gCurStampMode=l;gCurSealIndex=i;var g=document.getElementById("pageContainer1");var d=gPdfData.pdfWidth;var k=gPdfData.pdfHeight;var c=(e===null?gStampData.StampList[i].Width:e);var b=(a===null?gStampData.StampList[i].Height:a);var h=parseInt(g.style.width)/d;var j=parseInt(g.style.height)/k;var f=document.createElement("img");f.className="signSeal";f.id="sealInUse";f.width=c*h;f.height=b*j;f.style.top=0;f.style.left=0;f.style.position="absolute";f.style.display="none";f.src="data:image/bmp;base64,"+gStampData.StampList[i].ImageBinary;if(gCurUserSealRotate!==0){rotateDOMElement(f,gCurUserSealRotate)}$("#mainContainer").append(f);bMouseSeal=true}function performStamp(){var f,d,j,i,q,A,e,u;var z=document.getElementById("sealInUse");var v=document.getElementById("pageContainer1");var D=gPdfData.pdfWidth;var g=gPdfData.pdfHeight;var C=D/parseInt(v.style.width);var G=g/parseInt(v.style.height);if(gCurUserSealRotate===90||gCurUserSealRotate===270||gCurUserSealRotate===-90||gCurUserSealRotate===-270){q=parseInt(z.height);A=parseInt(z.width);if(A>=q){e=parseInt(z.style.left)+(A-q)/2;u=parseInt(z.style.top)-(A-q)/2}else{e=parseInt(z.style.left)-(A-q)/2;u=parseInt(z.style.top)+(A-q)/2}}else{q=parseInt(z.width);A=parseInt(z.height);e=parseInt(z.style.left);u=parseInt(z.style.top)}var a=PDFViewerApplication.pdfViewer.container.scrollTop+u-45;var o=parseInt(v.style.height)+10;var E=parseInt(v.style.width);var l=parseInt((a/o)+1);var m=parseInt(a%o);var n=parseInt($("#viewer").width());var b=0;if(n>=E){b=(n-E)/2}else{b=-(PDFViewerApplication.pdfViewer.container.scrollLeft)}f=e-b;var k=document.getElementById("sidebarContainer");if(getDefaultStyle(k,"left").toString()==="0px"){f-=210}d=parseInt(v.style.height)-(m-10);j=f+q;i=d-A;f*=C;d*=G;j*=C;i*=G;var t=gStampData.StampList[gCurSealIndex].StampID;var y=gStampData.StampList[gCurSealIndex].TrustID;var s=gPdfData.filePath;var p=false,x=false;if(gCurStampMode===1){p=true}else{if(gCurStampMode===2){x=true}}var B;if(gCurUserSealRotate===-90){B=270}else{if(gCurUserSealRotate===-180){B=180}else{if(gCurUserSealRotate===-270){B=90}else{B=gCurUserSealRotate}}}var r=[];r.push({StampID:t,PageIdx:l,Rota:B,LX:f,LY:d,RX:j,RY:i});var F={TrustID:y,Container:gCurCertContainer,FilePath:s,PIN:gPinCode,Random:Math.random(),stampInfo:r,signPerPage:p,pagingSeal:x};var c=b64EncodeUnicode(JSON.stringify(F));$.ajax({url:stamp_url,type:"get",dataType:"text",data:{jsonData:c},success:function(w,I,h){var H=jQuery.parseJSON(w);if(H.ResCode===0){gPdfData=H;renderPdf(H);if(gCurDocType===1){setTitle(gOnlineFile,1)}else{setTitle(gPdfData,0)}}else{alert(H.ResString)}ShowWaitingInfo("hidden")},error:function(h,H,w){switch(h.status){case 0:alert("http error.");break;case 500:alert("服务器系统内部错误");break;case 401:alert("访问被拒绝");break;case 403:alert("无权限执行此操作");break;case 408:alert("请求超时");break;default:alert("未知错误")}ShowWaitingInfo("hidden")}})}function pinCodeVerify(a){var b=new RegExp("^[0-9a-zA-Z]{6,16}$");if(!b.test(a)){return false}else{return true}}function ShowWaitingInfo(a){document.getElementById("waitingContainer").style.visibility=a}function SetWaitingInfo(a){document.getElementById("waitingInfo").innerText=a}function getDefaultStyle(b,a){return b.currentStyle?b.currentStyle[a]:document.defaultView.getComputedStyle(b,false)[a]}function showStampMenu(a){bOpendStampMenu=a;document.getElementById("stampMenuContainer").style.visibility=a?"visible":"hidden"}function switchSelectCurosrTool(){PDFViewerApplication.pdfCursorTools.switchTool(0);document.getElementById("cursorSelectTool").classList.add("toggled");document.getElementById("cursorHandTool").classList.remove("toggled")}var bCreateSealContainer=true;$(document).ready(function(){var d=function(f){var g=new RegExp("(^|&)"+f+"=([^&]*)(&|$)","i");var e=window.location.search;var h=e.substr(1).match(g);if(h!=null){return h[2]}return null};gUploadUrl=d("uploadUrl");gUploadFileName=d("uploadFileName");var a=d("file");if(a){openOnlineFile(a)}if(gUploadUrl===null||gUploadFileName===null){var c=document.getElementById("uploadFile");if(c){c.style.visibility="hidden"}}var b;b=d("openBtn");if(b){ShowToolbarBtn("openFile",b==="1"?true:false)}b=d("saveBtn");if(b){ShowToolbarBtn("saveFile",b==="1"?true:false)}b=d("printBtn");if(b){ShowToolbarBtn("print",b==="1"?true:false)}b=d("findBtn");if(b){ShowToolbarBtn("viewFind",b==="1"?true:false)}b=d("skipBtn");if(b){ShowToolbarBtn("pageSkip",b==="1"?true:false)}b=d("zoomBtn");if(b){ShowToolbarBtn("pageZoom",b==="1"?true:false)}b=d("stampBtn");if(b){ShowToolbarBtn("toolbarStamp",b==="1"?true:false)}b=d("cursorBtn");if(b){ShowToolbarBtn("cursorTool",b==="1"?true:false)}b=d("rotateBtn");if(b){ShowToolbarBtn("pageRotate",b==="1"?true:false)}$("#uploadFile").click(function(){if(gUploadUrl===null||gUploadFileName===null){alert("缺少参数！")}else{document.getElementById("uploadFileOverlayContainer").style.visibility="visible"}});$("#uploadFileCancel").click(function(){document.getElementById("uploadFileOverlayContainer").style.visibility="hidden"});$("#uploadFileOk").click(function(){document.getElementById("uploadFileOverlayContainer").style.visibility="hidden";SetWaitingInfo("正在上传文件");ShowWaitingInfo("visible");if(uploadFile(gUploadUrl,gUploadFileName)){ShowWaitingInfo("hidden");alert("文件上传成功！")}else{ShowWaitingInfo("hidden");alert("文件上传失败！")}});$("#viewerContainer").mousemove(function(n){if(gPdfData!==null){if(bCreateSealContainer){createSealContainer(gPdfData);bCreateSealContainer=false;setInterval("bCreateSealContainer = true",3000)}}if(bMouseSeal){var l="#sealInUse";var g=$("#viewer").width();var o=$("#pageContainer1").width();var m,i;m=$(l).width();i=$(l).height();var h=45;var f,k;f=g>o?(g-o)/2:10;if(gCurUserSealRotate===90||gCurUserSealRotate===270||gCurUserSealRotate===-90||gCurUserSealRotate===-270){if(m>=i){f-=(m-i)/2;k=f+o;k+=(m-i)}else{f+=(i-m)/2;k=f+o;k-=(i-m)}}var q=document.getElementById("sidebarContainer");if(getDefaultStyle(q,"left").toString()==="0px"){f+=210;k+=210}if(n.pageX<f||n.pageX>k||n.pageY<h){return}var j=0;if(n.pageX<(f+m/2)){j=f}else{if(n.pageX>(k-(m/2))){j=k-m}else{j=n.pageX-m/2}}var p=0;if(n.pageY<(h+(i/2))){p=h}else{p=n.pageY-i/2}$(l).css("border-style","dashed");$(l).css("border-width","thin");$(l).css("border-color","red");$(l).css("left",j);$(l).css("top",p);$(l).css("display","block");$(l).css("pointer-events","none")}});$("#viewerContainer").mousedown(function(j){if(j.which===3||j.which===1){if(bOpendStampMenu){bOpendStampMenu=false;document.getElementById("stampMenuContainer").style.visibility="hidden"}}if(bMouseSeal){if(j.which===3){bMouseSeal=false;$("#sealInUse").remove()}if(j.which===1){var i=0,g;var k=parseInt($("#viewer").width());var f=parseInt($("#pageContainer1").width());var h=document.getElementById("sidebarContainer");if(k>f){i=(k-f)/2;g=i+f;if(getDefaultStyle(h,"left").toString()==="0px"){i+=210;g+=190}if(j.pageX<i||j.pageX>g){return}}else{g=k-20;if(getDefaultStyle(h,"left").toString()==="0px"){i+=210;g+=210}if(j.pageX<i||j.pageX>g){bMouseSeal=false;$("#sealInUse").remove();return}}bMouseSeal=false;performStamp();$("#sealInUse").remove();SetWaitingInfo("正在进行签名");ShowWaitingInfo("visible")}}});$("#toolbarContainer").click(function(){if(bMouseSeal){bMouseSeal=false;$("#sealInUse").remove()}});$(".hiddenStamp").click(function(){if(bOpendStampMenu){bOpendStampMenu=false;document.getElementById("stampMenuContainer").style.visibility="hidden"}});$("#stampLoginOk").click(function(){var e=document.getElementById("stampLoingPinCode").value;if(!e){alert("PIN码不能为空！");return}if(pinCodeVerify(e)){gCurUserSealIndex=0;document.getElementById("stampLoginOverlayContainer").style.visibility="hidden";LoadSeal(e,1,gCurStampMode);SetWaitingInfo("正在获取印章");ShowWaitingInfo("visible")}else{alert("密码格式错误！")}});$("#stampLoginCancel").click(function(){document.getElementById("stampLoginOverlayContainer").style.visibility="hidden"});$("#stampLoginClose").click(function(){document.getElementById("stampLoginOverlayContainer").style.visibility="hidden"});$("#selectStamp").click(function(){if(!bDocSignValid){alert("文档存在无效签名，不支持盖章操作！");return}var f=document.getElementById("stampMenuContainer");if(bOpendStampMenu){bOpendStampMenu=false;f.style.visibility="hidden"}else{bOpendStampMenu=true;var e=document.getElementById("toolbarStamp");var h=e.offsetLeft+"px";var g="38px";f.style.left=h;f.style.top=g;f.style.visibility="visible"}});$("#useStamp").click(function(){gCurStampMode=0;gCurUserSealRotate=0;LoadSeal("",1,gCurStampMode)});$("#normalStamp").click(function(){showStampMenu(false);gCurStampMode=0;gCurUserSealRotate=0;LoadSeal("",1,gCurStampMode)});$("#allPageStamp").click(function(){showStampMenu(false);gCurStampMode=1;gCurUserSealRotate=0;LoadSeal("",1,gCurStampMode)});$("#pageGapStamp").click(function(){showStampMenu(false);gCurStampMode=2;gCurUserSealRotate=0;LoadSeal("",1,gCurStampMode)});$("#moreStamp").click(function(){showStampMenu(false);gCurStampMode=3;gCurUserSealRotate=0;LoadSeal("",1,gCurStampMode)});$("#exitStamp").click(function(){showStampMenu(false);gCurStampMode=0;gCurUserSealRotate=0;$.ajax({url:exitCertList_url,type:"get",success:function(f,g,e){gCurCertContainer=null;document.getElementById("certificateList").innerText="";alert("退出签章成功！")}})});$("#pageRotateCcw").click(function(){gRotateValue--;if(gRotateValue===0){gRotateValue=4}});$("#pageRotateCw").click(function(){gRotateValue++;if(gRotateValue===5){gRotateValue=1}});$("#saveFile").click(function(){if(gPdfData!=null){var e={Random:Math.random(),FilePath:""};var f=b64EncodeUnicode(JSON.stringify(e));$.ajax({url:saveAs_url,type:"get",dataType:"text",data:{jsonData:f},success:function(h,j,g){var i=jQuery.parseJSON(h);if(i.ResCOde===0){alert("保存成功！")}},error:function(h,i,g){alert("err = "+h)}})}else{alert("请先开启文档！")}});$("#removeSealCancel").click(function(){document.getElementById("removeSealOverlayContainer").style.visibility="hidden"});$("#removeSealOk").click(function(){document.getElementById("removeSealOverlayContainer").style.visibility="hidden";removeSeal()});$(".closeMySealDialog").click(function(){document.getElementById("userSealContainer").style.visibility="hidden"});$("#certificateList").change(function(){gCurCertContainer=$("#certificateList").find("option:selected").val()})});(function(){window.trustStamper={signPdfWithPosition:b,openFile_b64:c,isFileValid:j,getSignInfo:i,signB64Data:e,saveToFile:k,getStampData:h,saveAsFile:g,getCertList:d,uploadFile:p,autoRemoveStamp:o,getSignCert:m,ShowToolbarBtn:f};window.signPdfWithPosition=b;window.openFile_b64=c;window.isFileValid=j;window.getSignInfo=i;window.signB64Data=e;window.saveToFile=k;window.getStampData=h;window.saveAsFile=g;window.getCertList=d;window.uploadFile=p;window.autoRemoveStamp=o;window.getSignCert=m;window.ShowToolbarBtn=f;function f(s,q){if(typeof(s)==="string"){if(s==="pageSkip"){document.getElementById("previous").style.display=q?"inline":"none";document.getElementById("next").style.display=q?"inline":"none";document.getElementById("pageNumber").style.display=q?"inline":"none";return}else{if(s==="pageRotate"){document.getElementById("pageRotateCcw").style.display=q?"inline":"none";document.getElementById("pageRotateCw").style.display=q?"inline":"none";return}else{if(s==="cursorTool"){document.getElementById("cursorSelectTool").style.display=q?"inline":"none";document.getElementById("cursorHandTool").style.display=q?"inline":"none";return}else{if(s==="pageZoom"){document.getElementById("zoomIn").style.display=q?"inline":"none";document.getElementById("zoomOut").style.display=q?"inline":"none";return}}}}var r=document.getElementById(s);if(r){r.style.display=q?"inline":"none"}}}function b(q){if(q.docPath===""||q.docPath===undefined||typeof q.docPath!=="string"){return{ret:1,data:null}}if(q.pinCode===""||q.pinCode===undefined||typeof q.docPath!=="string"){return{ret:2,data:null}}if(q.sealIndex===undefined||typeof q.sealIndex!=="number"){return{ret:15,data:null}}if(q.stampType!==1&&q.stampType!==2&&q.stampType!==3&&typeof q.stampType!=="number"){return{ret:3,data:null}}if(q.rotate!==0&&q.rotate!==90&&q.rotate!==180&&q.rotate!==270&&typeof q.rotate!=="number"){return{ret:10,data:null}}if(typeof q.pos.curPage!=="number"){return{ret:12,data:null}}if(typeof q.pos.lx!=="number"){return{ret:13,data:null}}if(typeof q.pos.ly!=="number"){return{ret:14,data:null}}return n(q)}function n(t){var r={Random:Math.random(),Type:"Online",Url:t.docPath};var s=b64EncodeUnicode(JSON.stringify(r));var q={};q.doc=null;$.ajax({url:openFile_url,async:false,type:"get",dataType:"text",data:{jsonData:s},success:function(v,x,u){var w=jQuery.parseJSON(v);if(w.ResCode===0){gPdfData=w;if(t.pos.curPage<0||t.pos.curPage>w.pageCount){q.ret=11}else{t.filePath=w.filePath;q=l(t,"",1)}}else{if(w.ResCode===-101){q.ret=4}else{if(w.ResCode===-102){q.ret=5}else{q.ret=6}}}},error:function(u,w,v){q.ret=7}});return q}function c(t){var r={Random:Math.random(),Type:"base64",Url:t};var s=b64EncodeUnicode(JSON.stringify(r));var q=-1;$.ajax({url:openFile_url,async:false,type:"post",dataType:"text",data:{jsonData:s},success:function(v,x,u){var w=jQuery.parseJSON(v);if(w.ResCode===0){gPdfData=w;q=0}},error:function(v,w,u){alert("发送失败！")}});return q}function m(){var s={Random:Math.random(),CertType:"sign"};var r=b64EncodeUnicode(JSON.stringify(s));var q={};$.ajax({url:getSignCert_url,async:false,type:"post",dataType:"text",data:{jsonData:r},success:function(u,v,t){q=jQuery.parseJSON(u)},error:function(u,v,t){q.ResCode=-2;q.ResString="Http post err.";q.SignCert=null}});return q}function e(u,t){var r={Random:Math.random(),SignType:"P1",SignData:u,pin:t};var s=b64EncodeUnicode(JSON.stringify(r));var q={};$.ajax({url:signb64Data_url,async:false,type:"post",dataType:"text",data:{jsonData:s},success:function(w,x,v){q=jQuery.parseJSON(w)},error:function(w,x,v){q.ResCode=-2;q.ResString="Http post err.";q.SignValue=null}});return q}function j(){var q=0;if(gPdfData!==null){if(gPdfData.listVerify.length!==0){for(var r=0;r!==gPdfData.signatureList.length;++r){if(!gPdfData.listVerify[r].IsValid){q=1;break}}}else{q=2}}else{q=3}return q}function i(){if(gPdfData===null){return[]}else{return gPdfData.listVerify}}function l(t,u,s){var v={StampType:s,PIN:u,Random:Math.random()};var r=b64EncodeUnicode(JSON.stringify(v));var q={};q.doc=null;$.ajax({url:loadSeal_url,async:false,type:"get",dataType:"text",data:{jsonData:r},success:function(x,z,w){var y=jQuery.parseJSON(x);if(y.ResCode===0){if(t.sealIndex<0||t.sealIndex>=y.StampList.length){q.ret=16}else{q=a(t,y)}}else{if(y.ResCode===-1){q=l(t,t.pinCode,1)}else{q.ret=8}}},error:function(w,y,x){q.ret=7}});return q}function a(y,C){var x={};x.doc=null;var v,s,r,q;v=y.pos.lx;s=y.pos.ly+C.StampList[y.sealIndex].Height;r=v+C.StampList[y.sealIndex].Width;q=y.pos.ly;var u=[];u.push({StampID:C.StampList[y.sealIndex].StampID,PageIdx:y.pos.curPage,Rota:y.rotate,LX:v,LY:s,RX:r,RY:q});var A=false;var t=false;if(y.stampType===2){A=true}else{if(y.stampType===3){t=true}}var B=d();if(B.ResCode===-1||B.length===0){x.ret=17;return x}var w={TrustID:C.StampList[y.sealIndex].TrustID,FilePath:y.filePath,PIN:y.pinCode,Random:Math.random(),stampInfo:u,signPerPage:A,pagingSeal:t,Container:B[0].certContaimer};var z=b64EncodeUnicode(JSON.stringify(w));$.ajax({url:stamp_url,async:false,type:"get",dataType:"text",data:{jsonData:z},success:function(E,G,D){var F=jQuery.parseJSON(E);if(F.ResCode===0){gPdfData=F;x.ret=0;x.doc=F.fileData}else{x.ret=9}},error:function(D,F,E){x.ret=7}});return x}function k(){$.ajax({url:saveAs_url,type:"get",dataType:"text",data:{Random:Math.random()},success:function(r,t,q){var s=jQuery.parseJSON(r);if(s.ResCOde===0){alert("保存成功！")}},error:function(r,s,q){alert("err = "+r)}})}function p(r,u){var q=false;if(gPdfData.fileData===null||gPdfData.fileData===""||gPdfData.fileData===undefined){alert("上传PDF文件失败(PDF文件数据为空)");return q}if(r===null||r===""||r===undefined){alert("上传PDF文件失败(服务器地址异常)");return q}if(u===null||u===""||u===undefined){if(gOnlineFile!=null){u=gOnlineFile.split("/");u=u[u.length-1]}else{u="tmp.pdf"}}var t=new FormData();var s=b64toBlob(gPdfData.fileData);t.append("filename",u);t.append("file",s,u);$.ajax({url:r,type:"POST",data:t,async:false,cache:false,contentType:false,timeout:30000,processData:false,success:function(w,x,v){if(v.status===200||v.status===0){q=true}},error:function(v,x,w){q=false;alert("上传失败:"+v.status)}});return q}function h(t){var r={};var s={StampType:1,PIN:t,Random:Math.random()};var q=b64EncodeUnicode(JSON.stringify(s));if(q){$.ajax({async:false,url:loadSeal_url,type:"get",dataType:"json",data:{JsonData:q},success:function(v,w,u){if(w==="success"&&u.readyState===4){r=v}else{r.ResCode=-1;r.ResString=u.statusText}},error:function(u){r.ResCode=-1;r.ResString=u.statusText}})}else{r.ResCode=-1;r.ResString="b64EncodeUnicode error."}return r}function d(){var q=[];$.ajax({async:false,url:getCertList_url,success:function(s,t,r){q=jQuery.parseJSON(s)}});return q}function g(r){var q=false;var s={Random:Math.random(),FilePath:r};var t=b64EncodeUnicode(JSON.stringify(s));$.ajax({async:false,url:saveAs_url,dataType:"text",data:{jsonData:t},success:function(v,w,u){q=true}});return q}function o(t,v){var s={};s.resCode=0;s.resString="success";var q=function(){$.ajax({url:exitCertList_url,type:"get",success:function(y,z,x){gCurCertContainer=null}})};var w=function(z){var y={FilePath:z.filePath,PIN:v,Random:Math.random()};var x=b64EncodeUnicode(JSON.stringify(y));$.ajax({url:autoRemoveStamp_url,async:false,dataType:"text",data:{jsonData:x},success:function(B,D,A){var C=jQuery.parseJSON(B);if(C.ResCode===0){gPdfData=C}else{s.resCode=-1;s.resString=C.ResString}},error:function(){s.resCode=-1;s.resString="签章服务异常。"}})};var u={Random:Math.random(),Type:"Online",Url:t};var r=b64EncodeUnicode(JSON.stringify(u));$.ajax({url:openFile_url,async:false,dataType:"text",data:{jsonData:r},success:function(y,A,x){var z=jQuery.parseJSON(y);if(z.ResCode===0){w(z)}else{s.resCode=-1;s.resString="文档无法打开。"}},error:function(){s.resCode=-1;s.resString="签章服务异常。"}});q();return s}})();